{"actionType":"NEW","firmROEID":"20230908_MEOR_103986761_33028","type":"MEOR","CATReporterIMID":"BGWM","orderKeyDate":"20230825T000000.000000","orderID":"496435251","symbol":"DRI","eventTimestamp":"20230908T091028.000","manualFlag":false,"electronicDupFlag":false,"senderIMID":"104474:BGWM","destination":"7560:PERS","destinationType":"F","routedOrderID":"103986761","side":"SL","price":186.00000000,"quantity":2,"orderType":"LMT","timeInForce":{"DAY":20230908},"tradingSession":"REG","affiliateFlag":false,"isoInd":"NA","routeRejectedFlag":false,"dupROIDCond":false,"multiLegInd":false}


TradeDate, RecordType, FirmRoeID, Symbol, Side, OrderType, OrderID, Instructions, FirmDesignatedID, RoutedOrderID, EventTimeStamp, Quantity, Destination, ActionType, ReportedRecord, IsSubmitted, Jobkey, DataSource


CREATE PROCEDURE GetFilteredCorrectorRecords
    @ActionType NVARCHAR(10),  -- 'NEW', 'COR', 'DEL'
    @FirmRoeID NVARCHAR(50) = NULL,
    @TradeDate DATE = NULL,
    @RecordType NVARCHAR(20) = NULL,
    @OrderID NVARCHAR(50) = NULL,
    @Symbol NVARCHAR(10) = NULL,
    @Side NVARCHAR(10) = NULL
AS
BEGIN
    SET NOCOUNT ON;

    -- Fetch and filter records based on input parameters
    SELECT 
        TradeDate,
        RecordType,
        FirmRoeID,
        Symbol,
        Side,
        OrderType,
        OrderID,
        Instructions,
        FirmDesignatedID,
        RoutedOrderID,
        EventTimeStamp,
        Quantity,
        Destination,
        ActionType,
        IsSubmitted,
        Jobkey,
        DataSource,
        
        -- Parse JSON if COR or DEL
        CASE 
            WHEN ActionType IN ('COR', 'DEL') THEN 
                JSON_VALUE(ReportedRecord, '$.actionType') AS ParsedActionType,
                JSON_VALUE(ReportedRecord, '$.firmROEID') AS ParsedFirmROEID,
                JSON_VALUE(ReportedRecord, '$.orderID') AS ParsedOrderID,
                JSON_VALUE(ReportedRecord, '$.symbol') AS ParsedSymbol,
                JSON_VALUE(ReportedRecord, '$.eventTimestamp') AS ParsedEventTimestamp,
                JSON_VALUE(ReportedRecord, '$.quantity') AS ParsedQuantity,
                JSON_VALUE(ReportedRecord, '$.destination') AS ParsedDestination
            ELSE NULL
        END AS ParsedData
    FROM Corrector
    WHERE 
        ActionType = @ActionType
        AND (@FirmRoeID IS NULL OR FirmRoeID = @FirmRoeID)
        AND (@TradeDate IS NULL OR TradeDate = @TradeDate)
        AND (@RecordType IS NULL OR RecordType = @RecordType)
        AND (@OrderID IS NULL OR OrderID = @OrderID)
        AND (@Symbol IS NULL OR Symbol = @Symbol)
        AND (@Side IS NULL OR Side = @Side);
END;
